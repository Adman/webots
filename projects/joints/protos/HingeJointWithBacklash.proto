#VRML_SIM R2021b utf8
# license: Copyright Cyberbotics Ltd. Licensed for use only with Webots.
# license url: https://cyberbotics.com/webots_assets_license
# tags: static
# This extension of the hinge joint allows to model the effect of backlash.

PROTO HingeJointWithBacklash [
  field SFNode                                 jointParameters   HingeJointParameters {}
  field SFFloat                                backlash          0.1    # Defines the gear clearence, [0, inf).
  field SFFloat                                gearMass          0.01   # Defines the gear mass, [0, inf).
  field MFNode                                 device            [ ]    # {RotationalMotor, PositionSensor, Brake, PROTO}.
  field MFNode{PositionSensor{}}               outputSensor      [ ]    # {PositionSensor}.
  field MFNode{Group{}, Transform{}, Shape{}}  startPoint        NULL   # {Group, Transform, or Shape}.
  field SFNode                                 endPoint          NULL   # {Solid, SolidReference, or Slot}.
]
{
  %{
    -- load modules
    local os = require('os')
    local wbrandom = require('wbrandom')
    wbrandom.seed(os.clock() + os.time())
    -- parameter retrieval
    local axis = fields.jointParameters.value.fields.axis.value
    local anchor = fields.jointParameters.value.fields.anchor.value
    local position = fields.jointParameters.value.fields.position.value
    -- parameter sanity check
    local backlash = fields.backlash.value
    if backlash < 0 then
      io.stderr:write("'backlash' value must be positive, use a normal hinge if no backlash is desired.\n")
      backlash = fields.backlash.defaultValue
    end

    local gearMass = fields.gearMass.value
    if gearMass < 0 then
      io.stderr:write("'gearMass' value must be positive. Using default value.\n")
      gearMass = fields.gearMass.defaultValue
    end
  }%
  HingeJoint {
    jointParameters IS jointParameters
    device IS device
    position IS position
    endPoint Solid {
      name %{='"start_point_'..wbrandom.integer(0, 100000)..'"'}% # prevent name clashes
      children [
        %{ if fields.startPoint ~= nil then}%
        Group {
          children IS startPoint
        }
        %{ end }%
        HingeJoint {
          jointParameters HingeJointParameters {
            axis %{= axis.x}% %{= axis.y}% %{= axis.z}%
            anchor %{= anchor.x}% %{= anchor.y}% %{= anchor.z}%
            minStop %{= - backlash*0.5}%
            maxStop %{= backlash*0.5}%
            stopERP 0
          }
          device IS outputSensor
          endPoint IS endPoint
        }
      ]
      boundingObject Sphere {
        radius 0.0001
      }
      physics Physics {
        density -1
        mass IS gearMass
      }
    }
  }
}
